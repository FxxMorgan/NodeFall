<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Detecci√≥n de Ca√≠das - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        .alert-danger-bg { background: linear-gradient(45deg, #ff6b6b, #ee5a52); }
        .alert-warning-bg { background: linear-gradient(45deg, #feca57, #ff9ff3); }
        .alert-success-bg { background: linear-gradient(45deg, #48dbfb, #0abde3); }
        .alert-info-bg { background: linear-gradient(45deg, #3742fa, #2f3542); }
        
        #map {
            height: 400px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .recent-alerts {
            max-height: 400px;
            overflow-y: auto;
        }
        .alert-item {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .alert-item:hover {
            background: #fff0f0;
            transform: translateX(5px);
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.3rem;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-shield-alt"></i> Sistema de Detecci√≥n de Ca√≠das
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/register.html">
                    <i class="fas fa-user-plus"></i> Registrar Cuidador
                </a>
            </div>
        </div>
    </nav>

    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="container text-center">
            <h1 class="display-4 mb-3">
                <i class="fas fa-tachometer-alt"></i> Dashboard de Monitoreo
            </h1>
            <p class="lead">Monitoreo en tiempo real de dispositivos y alertas de ca√≠das</p>
            <small class="text-light">√öltima actualizaci√≥n: <span id="lastUpdate">--</span></small>
        </div>
    </div>

    <div class="container">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card p-4">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon alert-danger-bg me-3">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div>
                            <h5 class="mb-0" id="totalAlerts">0</h5>
                            <small class="text-muted">Alertas Totales</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card p-4">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon alert-warning-bg me-3">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <h5 class="mb-0" id="todayAlerts">0</h5>
                            <small class="text-muted">Alertas Hoy</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card p-4">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon alert-info-bg me-3">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div>
                            <h5 class="mb-0" id="activeDevices">0</h5>
                            <small class="text-muted">Dispositivos Activos</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card p-4">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon alert-success-bg me-3">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <h5 class="mb-0" id="totalCaregivers">0</h5>
                            <small class="text-muted">Cuidadores</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map and Recent Alerts -->
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="stat-card p-4">
                    <h5 class="mb-3">
                        <i class="fas fa-map-marker-alt text-danger"></i> 
                        Ubicaciones de Alertas Recientes
                    </h5>
                    <div id="map"></div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="stat-card p-4">
                    <h5 class="mb-3">
                        <i class="fas fa-list text-warning"></i> 
                        Alertas Recientes
                    </h5>
                    <div class="recent-alerts" id="recentAlertsList">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Cargando alertas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([19.4326, -99.1332], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        const markers = {};
        let alertData = [];

        // Custom marker icons
        const alertIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#dc3545;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);'></div>",
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        async function fetchAlerts() {
            try {
                const response = await fetch('/alerts');
                const data = await response.json();
                alertData = data.alerts || data;
                
                updateStatistics();
                updateMap();
                updateRecentAlerts();
                
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error fetching alerts:', error);
                showErrorMessage();
            }
        }

        function updateStatistics() {
            const today = new Date().toDateString();
            const todayAlerts = alertData.filter(alert => 
                new Date(alert.timestamp).toDateString() === today
            ).length;
            
            const uniqueDevices = [...new Set(alertData.map(alert => alert.deviceId))];
            
            document.getElementById('totalAlerts').textContent = alertData.length;
            document.getElementById('todayAlerts').textContent = todayAlerts;
            document.getElementById('activeDevices').textContent = uniqueDevices.length;
        }

        function updateMap() {
            // Clear existing markers
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            
            // Add new markers for recent alerts (last 10)
            const recentAlerts = alertData.slice(0, 10);
            recentAlerts.forEach(alert => {
                const marker = L.marker([alert.latitude, alert.longitude], {icon: alertIcon})
                    .addTo(map)
                    .bindPopup(`
                        <div class="p-2">
                            <h6 class="text-danger mb-2">üö® Alerta de Ca√≠da</h6>
                            <p class="mb-1"><strong>Dispositivo:</strong> ${alert.deviceId}</p>
                            <p class="mb-1"><strong>Hora:</strong> ${new Date(alert.timestamp).toLocaleString()}</p>
                            <p class="mb-0"><strong>Coordenadas:</strong> ${alert.latitude}, ${alert.longitude}</p>
                        </div>
                    `);
                markers[alert._id] = marker;
            });

            // Fit map to show all markers
            if (recentAlerts.length > 0) {
                const group = new L.featureGroup(Object.values(markers));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function updateRecentAlerts() {
            const container = document.getElementById('recentAlertsList');
            const recentAlerts = alertData.slice(0, 8);
            
            if (recentAlerts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                        <p class="mt-2">No hay alertas recientes</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recentAlerts.map(alert => `
                <div class="alert-item" onclick="focusOnAlert('${alert._id}')">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1 text-danger">
                                <i class="fas fa-exclamation-triangle"></i> 
                                Dispositivo ${alert.deviceId}
                            </h6>
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> 
                                ${new Date(alert.timestamp).toLocaleString()}
                            </small>
                            <br>
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt"></i> 
                                ${alert.latitude.toFixed(4)}, ${alert.longitude.toFixed(4)}
                            </small>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </div>
                </div>
            `).join('');
        }

        function focusOnAlert(alertId) {
            const marker = markers[alertId];
            if (marker) {
                map.setView(marker.getLatLng(), 15);
                marker.openPopup();
            }
        }

        function showErrorMessage() {
            document.getElementById('recentAlertsList').innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                    <p class="mt-2">Error al cargar las alertas</p>
                </div>
            `;
        }

        // Fetch caregivers count
        async function fetchCaregivers() {
            try {
                const response = await fetch('/caregivers');
                const caregivers = await response.json();
                document.getElementById('totalCaregivers').textContent = caregivers.length;
            } catch (error) {
                console.error('Error fetching caregivers:', error);
            }
        }

        // Initialize dashboard
        fetchAlerts();
        fetchCaregivers();
        
        // Auto-refresh every 30 seconds
        setInterval(fetchAlerts, 30000);
    </script>
</body>
</html>